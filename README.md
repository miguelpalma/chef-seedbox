# chef-seedbox

Chef kitchen to setup a complete seedbox

In the rest of this doc, we will assume you have a sudo enabled SSH login on a host and a network
alias `sbdev` pointing at it.

## Install a development/test environment

1. On your local computer, clone the source of this Git repository and install `knife-solo` and
`librarian-chef` using your package manager or:

    gem install knife-solo librarian-chef --no-ri --no-rdoc
    # You might need to fix the path version
    export PATH=$PATH:~/.gem/ruby/2.1.0/bin

FYI, the initial skeleton files were generated by running the following (these are handled by Git
and should thus not be run again):

    knife solo init .
    librarian-chef init

2. Install Vagrant

3. Download _Vagrant insecure public key_ to your SSH dir:

    wget -O ~/.ssh/id_rsa_vagrant     https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant
    wget -O ~/.ssh/id_rsa_vagrant.pub https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub

4. Start the virtual machine that we will use as development target environment:

    vagrant up

More configuration options are available for the virtual environment in the `Vagrantfile` file.
For instance, by default, Vagrant will not show VirtualBox' GUI. Uncomment the following lines and
reload the machine if you want it to be displayed upon boot:

    config.vm.provider "virtualbox" do |vb|
      vb.gui = true
    end

You should now be able to SSH into your virtual development target environment:

    ssh -i ~/.ssh/id_rsa_vagrant -p 2222 vagrant@localhost

To ease next steps, you could add these lines to your local ~/.ssh/config file:

    Host sbdev
        Hostname      localhost
        Port          2222
        User          vagrant
        IdentityFile  ~/.ssh/id_rsa_vagrant

This enables to SSH into the virtual machine with a simple `ssh sbdev`. Also, as this Git repo has
a `nodes/sbdev.json` file, Chef will be able to SSH to it and deploy this seedbox setup.

5. Install Chef on the remote host by issuing the following on your **local** machine (you will not
need to repeat this except if you wipe your virtual machine clean):

     knife --verbose solo prepare sbdev

6. Each time you make changes to this seedbox configuration, run the following on your **local**
machine to deploy it to the virtual machine:

    knife solo cook sbdev

## Adding a new recipe

Find a recipe for the application you want to install on
[Opscode community site](http://community.opscode.com/) and add its name to file `Cheffile`.
The following will then download all its dependencies to directory `cookbook`:

    librarian-chef install

NB: directory `cookbook` is **not** tracked by Git as cookbooks in it are automatically handled by
Librarian.

Also add it to the `nodes/sbdev.json` file along with attributes from recipes you wish to override.

## Documentation

- [knife-solo official doc](http://matschaffer.github.io/knife-solo/)
- This page is largely based on [Deploy a basic lamp stack to Digital Ocean with Chef Solo](http://adamcod.es/2013/06/04/deploy-a-basic-lamp-stack-digital-ocean-chef-solo.html)

## TODO

- Re-use pre-made cookbooks
  - apache2
  - fail2ban
  - munin
  - openssh
  - vsftpd

  - htpasswd (Manage an htpasswd file)
  - ssh-keys (Creates "authorized_keys" in user "~/.ssh" directory from a data bag)

- Use Nagios rules as TDD tests
